@page "/expenseline-list"

@inject IDialogService dialogService
@inject ISnackbar snackBarService

<div class='page-cont'>
    <div class='drawer-right'>
        <MudDrawer Class='pa-1' @bind-Open='openSideFilter' Fixed='false' Anchor='Anchor.Right' Elevation='0' Variant='DrawerVariant.Mini' OpenMiniOnHover='false'>
            <div class='drawer-right__filtercont'>
                <div class="icon-area d-flex align-center">
                    <MudIconButton OnClick='OpenSideFilter' Icon="@Icons.Filled.FilterList" aria-label="Filter" Size='Size.Medium' />
                </div>
                <div class="filter-title d-flex align-center">
                    <p class='title875'>Filter</p>
                    <MudSpacer />
                    <MudIconButton OnClick='OpenSideFilter' Icon="@Icons.Filled.Close" aria-label="Close Filter" Size='Size.Medium' />
                </div>
                <div class='filter-content d-flex flex-column pl-4 pr-4 gap-1 @visibility'>
                    <MudTextField Immediate=true Class='txtfield-75' @bind-Value='searchTerm' Placeholder='Expense Line'
                    Adornment='Adornment.Start' AdornmentIcon='@Icons.Material.Filled.Search' IconSize='Size.Small'
                    Clearable='true' Variant='Variant.Outlined' />
                    <MudButton Variant='Variant.Filled' Color='Color.Secondary'>Apply Filter</MudButton>
                </div>
            </div>
        </MudDrawer>
    </div>
    <MudContainer Class='divisionpage' Fixed='false' MaxWidth='MaxWidth.ExtraExtraLarge'>
        @if(!dataFetched)
        {
            <MudPaper Class='ma-1 pa-1' style="height: calc(100vh - 125px);">
                <MudSkeleton SkeletonType='SkeletonType.Text' Height='100px' Animation='Animation.Wave' />
                <MudSkeleton SkeletonType='SkeletonType.Rectangle' Height='71vh' Animation='Animation.Wave' />
            </MudPaper>
        }
        else
        {
            <MudTable Class='configtables' Items="@GlobalClassList.expenseLineList" Hover="true" 
            Breakpoint="Breakpoint.Sm" FixedHeader='true' FixedFooter='true' Bordered='true' Dense='true'
            RowsPerPage='30' Striped='true' Filter='new Func<ExpenseLineModel,bool>(FilterItems)'>
                <ToolBarContent>
                    <MudText Typo='Typo.caption'>
                        @GlobalClassList.expenseLineList.Count() 
                        @(GlobalClassList.expenseLineList.Count() == 1 ? "item" : "items") 
                        in Total
                    </MudText>
                    <MudSpacer/>
                    <MudMenu StartIcon='@Icons.Filled.MoreVert' AnchorOrigin='Origin.BottomLeft' 
                    TransformOrigin='Origin.TopCenter' Dense='true' Size='Size.Small' Label='More'>
                         <MudMenuItem OnClick='(() => ExpenseLineDialog(new ExpenseLineModel()))'>
                            <div class='d-flex align-center gap-2'>
                                <MudIcon Icon='@Icons.Filled.Add' Size='Size.Small' />
                                <MudText Typo='Typo.body2'>Add</MudText>
                            </div>
                        </MudMenuItem>
                         <MudMenuItem OnClick='OpenSideFilter'>
                            <div class='d-flex align-center gap-2'>
                            <MudIcon Icon='@Icons.Filled.FilterList' />
                            <MudText Typo='Typo.body2'>Filter</MudText>
                            </div>
                        </MudMenuItem>
                    </MudMenu>
                </ToolBarContent>
                <ColGroup>
                    <col />
                    <col style='width: 40px;' />
                    <col style='width: 40px;' />
                    <col style='width: 40px;' />
                </ColGroup>
                <HeaderContent>
                    <MudTh Class='customheader-1'>
                        <MudTableSortLabel InitialDirection="SortDirection.Ascending" 
                        SortBy="new Func<ExpenseLineModel, object>(x=>x.ExpenseName)">
                            Expense Name
                        </MudTableSortLabel>
                    </MudTh>
                    <MudTh Class='customheader-1 text-center'>Remarks</MudTh>
                    <MudTh Class='customheader-1 text-center'>Active</MudTh>
                    <MudTh Class='customheader-1 text-center'>Action</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Expense Line">
                        @context.ExpenseName
                        <div class='d-flex align-center'>
                            <MudIcon Size="Size.Small" Icon="@Icons.Filled.LabelImportant"></MudIcon>
                            <MudChip Class='chip-radius-5 font-bold font10 txt-uppercase' Variant='Variant.Text' Color='Color.Error' Size='Size.Small'>
                                @context.AccountTypeName
                            </MudChip>
                            <MudChip Class='chip-radius-5 font-bold font10 txt-uppercase' Variant='Variant.Text' Color='Color.Dark' Size='Size.Small'>
                                @context.AccountLineTypeName
                            </MudChip>
                            <MudChip Class='chip-radius-5 font-bold font10 txt-uppercase' Variant='Variant.Text' Color='Color.Primary' Size='Size.Small'>
                                @context.AccountLineGroupName
                            </MudChip>
                            <MudChip Class='chip-radius-5 font-bold font10 txt-uppercase' Variant='Variant.Text' Color='Color.Secondary' Size='Size.Small'>
                                @Extensions.GetEnumDescription((Enums.AccountReportGroup)context.AccountReportGroupId)
                            </MudChip>
                            <MudChip Class='chip-radius-5 font-bold font10 txt-uppercase' Variant='Variant.Text' Color='Color.Info' Size='Size.Small'>
                                @Extensions.GetEnumDescription((Enums.AccountDefaultBalance)context.AccountDefaultBalanceId)
                            </MudChip>
                            <MudSpacer />
                            <div class='d-flex align-start justify-start gap-4'>
                                <MudCheckBox Class='chkbxfont10 chkbxbold' Checked=@context.WithLedger ReadOnly='true' Label='w/Ledger' Size='Size.Small' Dense />
                            </div>
                        </div>
                    </MudTd>
                    <MudTd Class='text-center'>
                        <MudIconButton OnClick='(() => context.isShowChild = ShowChild(context.isShowChild,context))' Icon="@Icons.Filled.ListAlt" aria-label="Details" Size='Size.Small' />
                    </MudTd>
                    <MudTd Class='text-center'>
                        <MudCheckBox Checked=@context.IsActive ReadOnly='true' Size='Size.Small' Dense />
                    </MudTd>
                    <MudTd Class='text-center'>
                        <MudMenu Icon='@Icons.Filled.MoreVert' AnchorOrigin='Origin.BottomLeft'
                        TransformOrigin='Origin.TopCenter' Dense='true' Size='Size.Small'>
                                <MudMenuItem OnClick='(() => ExpenseLineDialog(context))'>
                                <div class='d-flex align-center gap-2'>
                                    <MudIcon Icon='@Icons.Filled.Edit' Size='Size.Small' />
                                    <MudText Typo='Typo.body2'>Edit</MudText>
                                </div>
                            </MudMenuItem>
                        </MudMenu>
                    </MudTd>
                </RowTemplate>
                <ChildRowContent>
                @if(context.isShowChild)
                {
                    <td colspan='5'>
                        <MudTr Class='d-flex justify-end align-center'>
                            <MudCard Class='pa-2 ma-2 d-flex align-center gap-6'>
                            <div class='d-flex align-center gap-2'>
                                <MudIcon Icon="@Icons.Filled.Message" Title="Account type" />
                                <MudText Typo='Typo.body2'>
                                    @(String.IsNullOrEmpty(context.Remarks) ? "No Remarks":context.Remarks)
                                </MudText>
                            </div>
                            </MudCard>
                        </MudTr>
                    </td>
                }
                </ChildRowContent>
                <PagerContent>
                    <MudTablePager PageSizeOptions='@pageSize' />
                </PagerContent>
            </MudTable>
        }
    </MudContainer>
</div>

@code
{
    private bool dataFetched, openSideFilter;
    private int[] pageSize = new int[] {30, 50, 100, 500, 1000 };
    private string searchTerm = string.Empty, visibility = "visibility-animation-hide";
    protected override async Task OnInitializedAsync()
    {
        GlobalClass.pageTitle = "Expense Line";
        while (GlobalClass.currentUserAccount == null || GlobalClassList.expenseLineList == null)
            await Task.Delay(1);
        CompletedFetch();
        SignalR();
    }
    private void CompletedFetch()
    {
        dataFetched = true;
        StateHasChanged();
    }
    private bool FilterItems(ExpenseLineModel items)
    {
        if (string.IsNullOrEmpty(searchTerm))
            return true;
        if (items.ExpenseName.Contains(searchTerm, StringComparison.InvariantCultureIgnoreCase))
            return true;
        return false;
    }
    private void OpenSideFilter()
    {
        openSideFilter = !openSideFilter;
        if(openSideFilter)
        visibility = "visibility-animation-show";
        if(!openSideFilter)
        visibility = "visibility-animation-hide";
    }
    private async Task ExpenseLineDialog(ExpenseLineModel expenseLine)
    {
        var parameters = new DialogParameters();
        GlobalClass.expenseLine = expenseLine;
        string dialogTitle = GlobalClass.expenseLine.Id != 0 ? "Edit Expense Line" : "Add Expense Line";
        string buttonText = GlobalClass.expenseLine.Id != 0 ? "Update" : "Add";
        Color color = GlobalClass.expenseLine.Id != 0 ? Color.Info : Color.Success;
        parameters.Add("color", color);
        parameters.Add("dialogTitle", dialogTitle);
        parameters.Add("buttonText", buttonText);
        var options = new DialogOptions()
        {
            CloseButton = false,
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true,
            NoHeader = false,
            DisableBackdropClick = false
        };
        var resultDialog = await dialogService.Show<Shared.Dialogs.ExpenseLineDialogs.ExpenseLineDialog>("", parameters, options).Result;
        if (!resultDialog.Cancelled)
        {
            if (resultDialog.Data.Equals(0))
                Extensions.ShowAlert("Added new Expense Line", Variant.Filled, snackBarService, Severity.Success);
            else if (resultDialog.Data.Equals(1))
                Extensions.ShowAlert("Updated Expense Line", Variant.Filled, snackBarService, Severity.Info);
        }
    }
    private void SignalR()
    {
        try
        {
            GlobalVariable.AMSHubConnection.On<ExpenseLineModel>("SaveExpenseLine",(expenseLineModel) => 
            {
                GlobalClassList.expenseLineList.RemoveAll(expense => expense.Id == expenseLineModel.Id);
                if(expenseLineModel.IsActive == true)
                    GlobalClassList.expenseLineList.Insert(0,expenseLineModel);
                StateHasChanged(); 
            });
        }catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
            throw;
        }
    }
    private bool ShowChild(bool isShow,ExpenseLineModel expenseLine)
    {
        @* GlobalClassList.expenseLineList.ForEach(model => {
            if(model.Id != expenseLine.Id)
                model.isShowChild = false;
        }); *@
        return isShow = !isShow;
    }
}