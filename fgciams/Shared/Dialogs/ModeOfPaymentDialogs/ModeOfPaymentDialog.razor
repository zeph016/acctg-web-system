@inject IModeOfPaymentService modeOfPaymentService
@inject ISnackbar snackBar
@inject IDialogService dialogService

<MudDialog class="customdialog">
    <TitleContent>
        <div class='d-flex align-center'>
            @if (GlobalClass.modeOfPayment.Id != 0)
            {
                <MudIcon Icon="@Icons.Filled.Edit" Class="mr-3" />
            }
            else
            {
                <MudIcon Icon="@Icons.Filled.Add" Class="mr-3" />
            }
            <MudText Typo='Typo.h6'>@dialogTitle</MudText>
        </div>
    </TitleContent>
    <DialogContent>
        <div class='customdialog__content-container'>
            <MudGrid Spacing='1'>
                <MudItem xs='9'>
                    <MudTextField @bind-Value='@GlobalClass.modeOfPayment.ModeName' Label='Mode Name' Error=@notValidModeName ErrorText="Required*"
                    HelperText="Required*"/>
                </MudItem>
                <MudItem Class='d-flex align-center' xs='3'>
                    <MudCheckBox @bind-Checked='@GlobalClass.modeOfPayment.IsActive' Label='Active' ReadOnly=@isReadOnly/>
                </MudItem>
            </MudGrid>
        </div>
    </DialogContent>
     <DialogActions>
        <MudButton OnClick="Cancel" Variant='Variant.Text'>Cancel</MudButton>
        <MudButton OnClick="Submit" Variant='Variant.Filled' Color="@color">@buttonText</MudButton>
    </DialogActions>
</MudDialog>
@code{
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = default!;
    [Parameter] public Color color { get; set; }
    [Parameter] public string dialogTitle { get; set; } = string.Empty;
    [Parameter] public string buttonText { get; set; } = string.Empty;
    private bool isReadOnly = false;
    private Enums.ActionMode currentAction {get;set;}
    private bool notValidModeName = false;
    protected override async Task OnInitializedAsync()
    {
        if(GlobalClass.modeOfPayment.Id == 0)
        {
            GlobalClass.modeOfPayment.IsActive = true;
            isReadOnly = true;
        }
        ResetValidation();
        await Task.Delay(1);
    }

    void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Submit()
    {
        if(GlobalClass.modeOfPayment.IsActive == false)
        {
            currentAction = Enums.ActionMode.Deactivate;
            await Prompt();
        }
        else 
        {
            if(IsValidated())
            {
                if(GlobalClass.modeOfPayment.Id == 0)
                    currentAction = Enums.ActionMode.Create;
                else
                    currentAction = Enums.ActionMode.Update;
                await Prompt();
            }
            else 
                Extensions.ShowAlert("Cannot "+currentAction.ToString().ToLower()+" mode of payment"+GlobalVariable.errorPromptText,Variant.Filled,snackBar,Severity.Error);
        }
    }
    private async Task Prompt()
    {
        var parameters = new DialogParameters();
        string contentText = " Mode of Payment";
        string dialogTitle = currentAction + contentText;
        parameters.Add("contentText", contentText);
        parameters.Add("actionMode", currentAction);
        var options = new DialogOptions()
        {
            CloseButton = false,
            MaxWidth = MaxWidth.ExtraSmall,
            FullWidth = true,
            NoHeader = false,
            DisableBackdropClick = true
        };
        var resultDialog = await dialogService.Show<Shared.Dialogs.GenericPromptDialogs.GenericPrompt>(dialogTitle, parameters, options).Result;
        if (!resultDialog.Cancelled) 
        {   
            try
            {
                if (currentAction == Enums.ActionMode.Create)
                {
                    GlobalClass.modeOfPayment = await modeOfPaymentService.AddModeOfPayment(GlobalClass.modeOfPayment, GlobalClass.token);
                    MudDialog.Close(DialogResult.Ok(0));
                }
                else
                {
                    GlobalClass.modeOfPayment = await modeOfPaymentService.UpdateModeOfpayment(GlobalClass.modeOfPayment, GlobalClass.token);
                    if(currentAction == Enums.ActionMode.Deactivate)
                        MudDialog.Close(DialogResult.Ok(2));
                    else
                         MudDialog.Close(DialogResult.Ok(1));
                }
                if(GlobalVariable.AMSHubConnection != null)
                    await GlobalVariable.AMSHubConnection.InvokeAsync("SaveModeOfPayment",GlobalClass.modeOfPayment);
            }catch (Exception ex) {
                Extensions.ShowAlert(ex.Message,Variant.Filled,snackBar,Severity.Info);
            }
        }
    }
    private bool IsValidated()
    {
        ResetValidation();
        if(String.IsNullOrEmpty(GlobalClass.modeOfPayment.ModeName))
            notValidModeName = true;
        if(notValidModeName) {
            GlobalVariable.errorPromptText = " incomplete field/s."; return false; }
        if(GlobalClassList.modeOfPaymentList.Any(x=>x.ModeName == GlobalClass.modeOfPayment.ModeName && x.Id != GlobalClass.modeOfPayment.Id)) {
            GlobalVariable.errorPromptText = " duplicate entry found for mode name."; return false; }
        return true;
    }
    private void ResetValidation()
    {
        notValidModeName = false;
    }
}